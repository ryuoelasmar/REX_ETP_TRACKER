{% set active_tab = 'rex' %}
{% extends "market/base.html" %}

{% block title %}REX View â€” REX Financial Intelligence Hub{% endblock %}

{% block market_content %}
{% if summary %}

{# KPI Cards #}
{% with kpis=summary.kpis, prefix='rex-' %}
{% include "market/_kpi_cards.html" %}
{% endwith %}

{# Charts Row #}
<div class="charts-row">
  <div class="chart-box">
    <h3>AUM by Suite</h3>
    <canvas id="suitesPieChart"></canvas>
  </div>
  <div class="chart-box">
    <h3>Total REX AUM Trend</h3>
    <canvas id="rexTrendChart"></canvas>
  </div>
</div>

{# ETF/ETN Filter Toggle #}
<div class="product-type-filter">
  <a href="/market/rex?product_type=All" class="filter-btn {{ 'active' if product_type == 'All' else '' }}">All</a>
  <a href="/market/rex?product_type=ETF" class="filter-btn {{ 'active' if product_type == 'ETF' else '' }}">ETF</a>
  <a href="/market/rex?product_type=ETN" class="filter-btn {{ 'active' if product_type == 'ETN' else '' }}">ETN</a>
</div>

{# Suite Cards #}
<h2 class="section-title">REX Suites</h2>

{# Suite show/hide checkboxes #}
<div class="suite-filter" id="suiteFilter">
  {% for suite in summary.suites %}
  <label>
    <input type="checkbox" checked data-suite="{{ suite.name }}" onchange="toggleSuite(this)">
    {{ suite.short_name }}
  </label>
  {% endfor %}
</div>

<div class="table-responsive">
<table class="data-table suite-table" id="suiteTable">
  <thead>
    <tr>
      <th>Suite</th>
      <th class="sortable" onclick="sortTable('suiteTable', 1)">AUM</th>
      <th class="sortable" onclick="sortTable('suiteTable', 2)">1W Flow</th>
      <th class="sortable" onclick="sortTable('suiteTable', 3)">1M Flow</th>
      <th class="sortable" onclick="sortTable('suiteTable', 4)">Mkt Share</th>
      <th class="sortable" onclick="sortTable('suiteTable', 5)"># Funds</th>
      <th>4-mo Trend</th>
      <th>Top Movers</th>
    </tr>
  </thead>
  <tbody>
    {% for suite in summary.suites %}
    <tr data-suite="{{ suite.name }}">
      <td><a href="/market/category?cat={{ suite.name|urlencode }}" class="text-link">{{ suite.short_name }}</a></td>
      <td class="num-cell" data-sort="{{ suite.kpis.total_aum|default(0) }}">{{ suite.kpis.aum_fmt }}</td>
      <td class="num-cell {{ 'positive' if suite.kpis.flow_1w > 0 else 'negative' if suite.kpis.flow_1w < 0 else '' }}" data-sort="{{ suite.kpis.flow_1w|default(0) }}">{{ suite.kpis.flow_1w_fmt }}</td>
      <td class="num-cell {{ 'positive' if suite.kpis.flow_1m > 0 else 'negative' if suite.kpis.flow_1m < 0 else '' }}" data-sort="{{ suite.kpis.flow_1m|default(0) }}">{{ suite.kpis.flow_1m_fmt }}</td>
      <td class="num-cell" data-sort="{{ suite.market_share|default(0) }}">{{ suite.market_share }}%</td>
      <td class="num-cell" data-sort="{{ suite.kpis.num_products|default(0) }}">{{ suite.kpis.num_products }}</td>
      <td style="min-width:90px;"><canvas id="sparkline-{{ suite.short_name|replace(' ', '-') }}" width="88" height="30" class="sparkline-canvas"></canvas></td>
      <td class="movers-cell">{% for m in suite.top_movers[:3] %}<span class="{{ 'positive' if m.flow_raw > 0 else 'negative' if m.flow_raw < 0 else '' }}">{{ m.ticker }} {{ m.flow }}</span>{% if not loop.last %} &middot; {% endif %}{% endfor %}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>
</div>

{% else %}
<div class="alert alert-warning">No REX data available.</div>
{% endif %}
{% endblock %}

{% block market_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  {% if summary %}
  // Pie chart - AUM by suite
  var pieData = {{ summary.pie_data|tojson }};
  MarketCharts.renderPieChart('suitesPieChart', pieData.labels, pieData.values);
  {% endif %}

  {% if trend %}
  // Line chart - REX AUM trend
  var trendData = {{ trend|tojson }};
  MarketCharts.renderLineChart('rexTrendChart', trendData.labels, [
    {label: 'REX AUM', data: trendData.values, color: '#1E40AF'}
  ]);
  {% endif %}

  // Sparklines
  {% if summary %}
  {% for suite in summary.suites %}
  {% if suite.sparkline_data %}
  MarketCharts.renderSparkline('sparkline-{{ suite.short_name|replace(" ", "-") }}', {{ suite.sparkline_data|tojson }});
  {% endif %}
  {% endfor %}
  {% endif %}
});

function toggleSuite(checkbox) {
  var suiteName = checkbox.getAttribute('data-suite');
  var rows = document.querySelectorAll('tr[data-suite="' + suiteName + '"]');
  rows.forEach(function(row) {
    row.style.display = checkbox.checked ? '' : 'none';
  });
}
</script>
{% endblock %}
