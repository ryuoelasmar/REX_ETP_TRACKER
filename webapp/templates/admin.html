{% extends "base.html" %}
{% block title %}Admin Panel - ETP Filing Tracker{% endblock %}

{% block content %}
<div class="header">
  <h1>Admin Panel</h1>
  <div class="date">
    System management &middot;
    <a href="/admin/logout" style="font-size:13px;">Logout</a>
  </div>
</div>

<!-- Status Banners -->
{% if request.query_params.get('approved') %}
<div style="background:#e8f5e9; border-left:4px solid var(--green); padding:12px 16px; border-radius:0 8px 8px 0; margin-bottom:16px;">
  <strong style="color:var(--green);">Trust approved</strong> and added to monitoring. Run the pipeline to fetch its filings.
</div>
{% endif %}
{% if request.query_params.get('rejected') %}
<div style="background:#fff3cd; border-left:4px solid #ffc107; padding:12px 16px; border-radius:0 8px 8px 0; margin-bottom:16px;">
  Request rejected.
</div>
{% endif %}
{% if request.query_params.get('pipeline') == 'started' %}
<div style="background:#e8f5e9; border-left:4px solid var(--green); padding:12px 16px; border-radius:0 8px 8px 0; margin-bottom:16px;">
  <strong style="color:var(--green);">Pipeline started.</strong> This runs in the background (30-60 min). Page will auto-refresh.
</div>
{% elif request.query_params.get('pipeline') == 'running' %}
<div style="background:#e3f2fd; border-left:4px solid var(--blue); padding:12px 16px; border-radius:0 8px 8px 0; margin-bottom:16px;">
  Pipeline is already running. Please wait for it to finish.
</div>
{% elif request.query_params.get('pipeline') == 'error' %}
<div style="background:#fce4ec; border-left:4px solid var(--red); padding:12px 16px; border-radius:0 8px 8px 0; margin-bottom:16px;">
  <strong style="color:var(--red);">Pipeline error:</strong> {{ request.query_params.get('msg', 'Unknown error') }}
</div>
{% endif %}
{% if request.query_params.get('digest') == 'sent' %}
<div style="background:#e8f5e9; border-left:4px solid var(--green); padding:12px 16px; border-radius:0 8px 8px 0; margin-bottom:16px;">
  <strong style="color:var(--green);">Digest sent successfully.</strong> Check your inbox.
</div>
{% elif request.query_params.get('digest') == 'fail' %}
<div style="background:#fce4ec; border-left:4px solid var(--red); padding:12px 16px; border-radius:0 8px 8px 0; margin-bottom:16px;">
  <strong style="color:var(--red);">Failed to send digest.</strong> Check email configuration (Azure Graph or SMTP).
</div>
{% elif request.query_params.get('digest') == 'no_files' %}
<div style="background:#fff3cd; border-left:4px solid #ffc107; padding:12px 16px; border-radius:0 8px 8px 0; margin-bottom:16px;">
  <strong>No pipeline data found.</strong> Run the pipeline at least once to generate filing data.
</div>
{% elif request.query_params.get('digest') == 'error' %}
<div style="background:#fce4ec; border-left:4px solid var(--red); padding:12px 16px; border-radius:0 8px 8px 0; margin-bottom:16px;">
  <strong style="color:var(--red);">Digest error:</strong> {{ request.query_params.get('msg', 'Unknown error') }}
</div>
{% endif %}
{% if request.query_params.get('error') == 'missing_data' %}
<div style="background:#fce4ec; border-left:4px solid var(--red); padding:12px 16px; border-radius:0 8px 8px 0; margin-bottom:16px;">
  Missing CIK or trust name.
</div>
{% endif %}

<div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:24px;">

  <!-- Pipeline Control -->
  <div style="border:1px solid var(--border); border-radius:8px; padding:20px; background:var(--light);">
    <h3 style="margin:0 0 12px; font-size:16px;">Pipeline Control</h3>

    {% if pipeline_running %}
    <div style="padding:10px 14px; background:#e3f2fd; border:1px solid #90caf9; border-radius:6px; font-size:13px; margin-bottom:12px;">
      Pipeline is currently <strong>running</strong>... <span id="pipelineDots"></span>
    </div>
    {% endif %}

    {% if last_run %}
    <div style="font-size:13px; color:var(--muted); margin-bottom:12px;">
      <div>Last run:
        {% if last_run.status == 'completed' %}
        <strong style="color:var(--green);">{{ last_run.status }}</strong>
        {% elif last_run.status == 'failed' or last_run.status == 'interrupted' %}
        <strong style="color:var(--red);">{{ last_run.status }}</strong>
        {% else %}
        <strong>{{ last_run.status }}</strong>
        {% endif %}
      </div>
      <div>Started: {{ last_run.started_at.strftime('%Y-%m-%d %H:%M') if last_run.started_at else 'N/A' }}</div>
      {% if last_run.finished_at %}
      <div>Finished: {{ last_run.finished_at.strftime('%Y-%m-%d %H:%M') }}</div>
      {% endif %}
      {% if last_run.trusts_processed %}
      <div>Trusts processed: {{ last_run.trusts_processed }}</div>
      {% endif %}
      {% if last_run.error_message %}
      <div style="color:var(--red); margin-top:4px;">{{ last_run.error_message[:150] }}</div>
      {% endif %}
    </div>
    {% else %}
    <p style="font-size:13px; color:var(--muted); margin-bottom:12px;">No pipeline runs recorded yet.</p>
    {% endif %}

    <form method="post" action="/admin/pipeline/run"
          onsubmit="return confirm('Run the full pipeline now?\n\nThis fetches all SEC filings, extracts fund data, and syncs to the database.\nIt runs in the background and takes 30-60 minutes.');">
      <button type="submit" class="btn btn-primary" {% if pipeline_running %}disabled{% endif %}>
        {% if pipeline_running %}Pipeline Running...{% else %}Run Pipeline Now{% endif %}
      </button>
    </form>
  </div>

  <!-- Email Digest -->
  <div style="border:1px solid var(--border); border-radius:8px; padding:20px; background:var(--light);">
    <h3 style="margin:0 0 12px; font-size:16px;">Email Digest</h3>
    <p style="font-size:13px; color:var(--muted); margin-bottom:12px;">
      Send the daily digest email to all recipients in email_recipients.txt using current pipeline data.
    </p>
    <form method="post" action="/admin/digest/send"
          onsubmit="return confirm('Send digest email to all recipients now?');">
      <button type="submit" class="btn btn-primary">Send Digest Now</button>
    </form>
  </div>

</div>

<!-- Trust Requests -->
<div style="border:1px solid var(--border); border-radius:8px; padding:20px; margin-bottom:24px; background:var(--light);">
  <h3 style="margin:0 0 4px; font-size:16px;">Pending Trust Requests</h3>
  <p style="font-size:13px; color:var(--muted); margin-bottom:16px;">
    Users submit monitoring requests via the Search page. Approve to add to the database and automatically fetch filings.
  </p>

  {% if pending_requests %}
  <table>
    <thead>
      <tr>
        <th>Trust Name</th>
        <th>CIK</th>
        <th>Requested</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for r in pending_requests %}
      <tr>
        <td><strong>{{ r.name }}</strong></td>
        <td style="font-size:12px;">{{ r.cik }}</td>
        <td style="font-size:12px; color:var(--muted);">{{ r.timestamp }}</td>
        <td>
          <form method="post" action="/admin/requests/approve" style="display:inline;">
            <input type="hidden" name="cik" value="{{ r.cik }}">
            <input type="hidden" name="name" value="{{ r.name }}">
            <button type="submit" class="btn btn-sm" style="background:var(--green); color:white; border:none;"
                    onclick="return confirm('Approve {{ r.name }}?\n\nThis will add the trust and start fetching its filings.');">Approve</button>
          </form>
          <form method="post" action="/admin/requests/reject" style="display:inline; margin-left:4px;">
            <input type="hidden" name="cik" value="{{ r.cik }}">
            <button type="submit" class="btn btn-sm" style="background:var(--red); color:white; border:none;"
                    onclick="return confirm('Reject this request?');">Reject</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <div style="text-align:center; padding:20px; color:var(--muted); font-size:13px;">
    No pending requests. Users can submit requests from the <a href="/search/">Search</a> page.
  </div>
  {% endif %}

  {% if all_requests %}
  <details style="margin-top:12px;">
    <summary style="font-size:12px; color:var(--muted); cursor:pointer;">View all requests ({{ all_requests|length }} total)</summary>
    <table style="margin-top:8px;">
      <thead>
        <tr><th>Status</th><th>Name</th><th>CIK</th><th>Date</th></tr>
      </thead>
      <tbody>
        {% for r in all_requests %}
        <tr>
          <td>
            {% if r.status == 'APPROVED' %}
            <span style="color:var(--green); font-weight:600;">APPROVED</span>
            {% elif r.status == 'REJECTED' %}
            <span style="color:var(--red); font-weight:600;">REJECTED</span>
            {% else %}
            <span style="color:var(--orange); font-weight:600;">PENDING</span>
            {% endif %}
          </td>
          <td>{{ r.name }}</td>
          <td style="font-size:12px;">{{ r.cik }}</td>
          <td style="font-size:12px;">{{ r.timestamp }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </details>
  {% endif %}
</div>

<!-- Launch Screener -->
<div style="border:1px solid var(--border); border-radius:8px; padding:20px; margin-bottom:24px; background:var(--light);">
  <h3 style="margin:0 0 4px; font-size:16px;">Launch Screener</h3>
  <p style="font-size:13px; color:var(--muted); margin-bottom:16px;">
    Bloomberg data scoring pipeline. Upload new data or re-score existing data in data/SCREENER/.
  </p>

  {% if request.query_params.get('screener') == 'uploaded' %}
  <div style="background:#e8f5e9; border-left:4px solid var(--green); padding:10px 14px; border-radius:0 6px 6px 0; margin-bottom:12px; font-size:13px;">
    <strong style="color:var(--green);">Data uploaded.</strong> Scoring pipeline started. Page will auto-refresh.
  </div>
  {% elif request.query_params.get('screener') == 'scoring' %}
  <div style="background:#e3f2fd; border-left:4px solid var(--blue); padding:10px 14px; border-radius:0 6px 6px 0; margin-bottom:12px; font-size:13px;">
    <strong style="color:var(--blue);">Scoring started.</strong> Results will update shortly.
  </div>
  {% elif request.query_params.get('screener') == 'running' %}
  <div style="background:#e3f2fd; border-left:4px solid var(--blue); padding:10px 14px; border-radius:0 6px 6px 0; margin-bottom:12px; font-size:13px;">
    Screener pipeline is already running. Please wait.
  </div>
  {% elif request.query_params.get('screener') == 'emailed' %}
  <div style="background:#e8f5e9; border-left:4px solid var(--green); padding:10px 14px; border-radius:0 6px 6px 0; margin-bottom:12px; font-size:13px;">
    <strong style="color:var(--green);">Screener report emailed successfully.</strong>
  </div>
  {% elif request.query_params.get('screener') == 'error' %}
  <div style="background:#fce4ec; border-left:4px solid var(--red); padding:10px 14px; border-radius:0 6px 6px 0; margin-bottom:12px; font-size:13px;">
    <strong style="color:var(--red);">Error:</strong> {{ request.query_params.get('msg', 'Upload failed') }}
  </div>
  {% endif %}

  {% if screener_upload %}
  <div style="font-size:13px; color:var(--muted); margin-bottom:12px;">
    <div>Last scored: <strong>{{ screener_upload.uploaded_at.strftime('%Y-%m-%d %H:%M') }}</strong>
      {% if screener_upload.status == 'completed' %}
      <span style="color:var(--green); font-weight:600;">(completed)</span>
      {% elif screener_upload.status == 'processing' %}
      <span style="color:var(--blue); font-weight:600;">(processing...)</span>
      {% else %}
      <span style="color:var(--red); font-weight:600;">({{ screener_upload.status }})</span>
      {% endif %}
    </div>
    {% if screener_upload.stock_rows %}
    <div>Stocks: {{ screener_upload.stock_rows }} | ETPs: {{ screener_upload.etp_rows }}</div>
    {% endif %}
    {% if screener_upload.error_message %}
    <div style="color:var(--red);">Error: {{ screener_upload.error_message[:150] }}</div>
    {% endif %}
  </div>
  {% endif %}

  {% if screener_data_available and not screener_upload %}
  <div style="background:#fff3e0; border-left:4px solid var(--orange); padding:10px 14px; border-radius:0 6px 6px 0; margin-bottom:12px; font-size:13px;">
    <strong>Bloomberg data detected</strong> in data/SCREENER/. Click <strong>Score Data</strong> to process it.
  </div>
  {% endif %}

  <div style="display:flex; gap:12px; flex-wrap:wrap;">
    <form method="post" action="/admin/screener/rescore"
          onsubmit="return confirm('Score the Bloomberg data in data/SCREENER/?');">
      <button type="submit" class="btn btn-primary btn-sm">Score Data</button>
    </form>
    <form method="post" action="/admin/screener/upload" enctype="multipart/form-data" style="display:flex; gap:8px; align-items:center;">
      <input type="file" name="file" accept=".xlsx" required style="font-size:13px;">
      <button type="submit" class="btn btn-sm" style="background:var(--blue); color:white; border:none;">Upload New Data</button>
    </form>
    {% if screener_upload and screener_upload.status == 'completed' %}
    <form method="post" action="/admin/screener/email"
          onsubmit="return confirm('Generate PDF and email the screener report?');">
      <button type="submit" class="btn btn-sm" style="background:var(--green); color:white; border:none;">Email Report</button>
    </form>
    {% endif %}
  </div>

  {% if screener_upload and screener_upload.status == 'completed' %}
  <div style="margin-top:12px;">
    <a href="/screener/" style="font-size:13px;">View Screener Results &rarr;</a>
  </div>
  {% endif %}
</div>

<!-- AI Analysis Status -->
<div style="border:1px solid var(--border); border-radius:8px; padding:20px; margin-bottom:24px; background:var(--light);">
  <h3 style="margin:0 0 12px; font-size:16px;">AI Analysis Status</h3>
  <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
    <div>
      <div style="font-size:13px; color:var(--muted);">Claude API Key</div>
      <div style="font-size:15px; font-weight:600; margin-top:2px;">
        {% if ai_configured %}
        <span style="color:var(--green);">Configured</span>
        {% else %}
        <span style="color:var(--red);">Not configured</span>
        {% endif %}
      </div>
    </div>
    <div>
      <div style="font-size:13px; color:var(--muted);">Analyses Today</div>
      <div style="font-size:15px; font-weight:600; margin-top:2px;">{{ ai_usage_today }} / 10</div>
    </div>
  </div>
</div>

<!-- Auto-refresh when pipeline or screener is running -->
{% if pipeline_running or (screener_upload and screener_upload.status == 'processing') %}
<script>
  setTimeout(function() { window.location.href = '/admin/'; }, 15000);
</script>
{% endif %}
{% if request.query_params.get('screener') in ['uploaded', 'scoring'] %}
<script>
  setTimeout(function() { window.location.href = '/admin/'; }, 10000);
</script>
{% endif %}

{% endblock %}
