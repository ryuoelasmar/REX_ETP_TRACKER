{% extends "base.html" %}
{% block title %}Admin Panel - ETP Filing Tracker{% endblock %}

{% block content %}
<div class="header">
  <h1>Admin Panel</h1>
  <div class="date">
    System management &middot;
    <a href="/admin/logout" style="font-size:13px;">Logout</a>
  </div>
</div>

<!-- Status Banners -->
{% if request.query_params.get('approved') %}
<div style="background:var(--green-bg); border-left:4px solid var(--green); padding:12px 16px; border-radius:0 8px 8px 0; margin-bottom:16px;">
  <strong style="color:var(--green);">Trust approved</strong> and added to monitoring. It will be included in the next pipeline run.
</div>
{% endif %}
{% if request.query_params.get('rejected') %}
<div style="background:var(--orange-bg); border-left:4px solid var(--orange); padding:12px 16px; border-radius:0 8px 8px 0; margin-bottom:16px;">
  Request rejected.
</div>
{% endif %}
{% if request.query_params.get('approved_sub') %}
<div style="background:var(--green-bg); border-left:4px solid var(--green); padding:12px 16px; border-radius:0 8px 8px 0; margin-bottom:16px;">
  <strong style="color:var(--green);">Subscriber approved</strong> and added to email_recipients.txt.
</div>
{% endif %}
{% if request.query_params.get('rejected_sub') %}
<div style="background:var(--orange-bg); border-left:4px solid var(--orange); padding:12px 16px; border-radius:0 8px 8px 0; margin-bottom:16px;">
  Subscriber rejected.
</div>
{% endif %}
{% if request.query_params.get('digest') == 'sent' %}
<div style="background:var(--green-bg); border-left:4px solid var(--green); padding:12px 16px; border-radius:0 8px 8px 0; margin-bottom:16px;">
  <strong style="color:var(--green);">Daily digest sent successfully.</strong> Check your inbox.
</div>
{% elif request.query_params.get('digest') == 'weekly_sent' %}
<div style="background:var(--green-bg); border-left:4px solid var(--green); padding:12px 16px; border-radius:0 8px 8px 0; margin-bottom:16px;">
  <strong style="color:var(--green);">Weekly intelligence brief sent successfully.</strong> Check your inbox.
</div>
{% elif request.query_params.get('digest') == 'weekly_fail' %}
<div style="background:var(--red-bg); border-left:4px solid var(--red); padding:12px 16px; border-radius:0 8px 8px 0; margin-bottom:16px;">
  <strong style="color:var(--red);">Failed to send weekly brief.</strong> Check email configuration.
</div>
{% elif request.query_params.get('digest') == 'fail' %}
<div style="background:var(--red-bg); border-left:4px solid var(--red); padding:12px 16px; border-radius:0 8px 8px 0; margin-bottom:16px;">
  <strong style="color:var(--red);">Failed to send digest.</strong> Check email configuration (Azure Graph or SMTP).
</div>
{% elif request.query_params.get('digest') == 'error' %}
<div style="background:var(--red-bg); border-left:4px solid var(--red); padding:12px 16px; border-radius:0 8px 8px 0; margin-bottom:16px;">
  <strong style="color:var(--red);">Digest error:</strong> {{ request.query_params.get('msg', 'Unknown error') }}
</div>
{% endif %}
{% if request.query_params.get('error') == 'missing_data' %}
<div style="background:var(--red-bg); border-left:4px solid var(--red); padding:12px 16px; border-radius:0 8px 8px 0; margin-bottom:16px;">
  Missing CIK or trust name.
</div>
{% endif %}

<!-- Pending Trust Requests -->
<div style="border:1px solid var(--border); border-radius:8px; padding:20px; margin-bottom:24px; background:var(--light);">
  <h3 style="margin:0 0 4px; font-size:16px;">Pending Trust Requests</h3>
  <p style="font-size:13px; color:var(--muted); margin-bottom:16px;">
    Users submit monitoring requests via the Search page. Approve to add to the database and trusts.py for the next pipeline run.
  </p>

  {% if pending_requests %}
  <table>
    <thead>
      <tr>
        <th>Trust Name</th>
        <th>CIK</th>
        <th>Requested</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for r in pending_requests %}
      <tr>
        <td><strong>{{ r.name }}</strong></td>
        <td style="font-size:12px;">{{ r.cik }}</td>
        <td style="font-size:12px; color:var(--muted);">{{ r.timestamp }}</td>
        <td>
          <form method="post" action="/admin/requests/approve" style="display:inline;">
            <input type="hidden" name="cik" value="{{ r.cik }}">
            <input type="hidden" name="name" value="{{ r.name }}">
            <button type="submit" class="btn btn-sm" style="background:var(--green); color:white; border:none;"
                    onclick="return confirm('Approve {{ r.name }}?\n\nThis will add the trust to trusts.py and the database.');">Approve</button>
          </form>
          <form method="post" action="/admin/requests/reject" style="display:inline; margin-left:4px;">
            <input type="hidden" name="cik" value="{{ r.cik }}">
            <button type="submit" class="btn btn-sm" style="background:var(--red); color:white; border:none;"
                    onclick="return confirm('Reject this request?');">Reject</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <div style="text-align:center; padding:20px; color:var(--muted); font-size:13px;">
    No pending requests. Users can submit requests from the <a href="/search/">Search</a> page.
  </div>
  {% endif %}

  {% if all_requests %}
  <details style="margin-top:12px;">
    <summary style="font-size:12px; color:var(--muted); cursor:pointer;">View all requests ({{ all_requests|length }} total)</summary>
    <table style="margin-top:8px;">
      <thead>
        <tr><th>Status</th><th>Name</th><th>CIK</th><th>Date</th></tr>
      </thead>
      <tbody>
        {% for r in all_requests %}
        <tr>
          <td>
            {% if r.status == 'APPROVED' %}
            <span style="color:var(--green); font-weight:600;">APPROVED</span>
            {% elif r.status == 'REJECTED' %}
            <span style="color:var(--red); font-weight:600;">REJECTED</span>
            {% else %}
            <span style="color:var(--orange); font-weight:600;">PENDING</span>
            {% endif %}
          </td>
          <td>{{ r.name }}</td>
          <td style="font-size:12px;">{{ r.cik }}</td>
          <td style="font-size:12px;">{{ r.timestamp }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </details>
  {% endif %}
</div>

<!-- Email Digest + Subscribers -->
<div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:24px;">

  <!-- Email Digest -->
  <div style="border:1px solid var(--border); border-radius:8px; padding:20px; background:var(--light);">
    <h3 style="margin:0 0 12px; font-size:16px;">Email Digest</h3>
    <p style="font-size:13px; color:var(--muted); margin-bottom:12px;">
      Send digest emails to all approved recipients using current database data.
    </p>
    <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px;">
      <form method="post" action="/admin/digest/send"
            onsubmit="return confirm('Send DAILY brief email now?');">
        <button type="submit" class="btn" style="background:#1a1a2e; color:#fff; border:none;">Send Daily Brief</button>
      </form>
      <form method="post" action="/admin/digest/send-weekly"
            onsubmit="return confirm('Send WEEKLY report email now?');">
        <button type="submit" class="btn" style="background:#0984e3; color:#fff; border:none;">Send Weekly Report</button>
      </form>
    </div>
    <div style="display:flex; gap:8px; flex-wrap:wrap;">
      <a href="/admin/digest/preview-daily" target="_blank"
         class="btn" style="background:#f8f9fa; color:#1a1a2e; border:1px solid #dee2e6; text-decoration:none; display:inline-block; text-align:center;">Preview Daily</a>
      <a href="/admin/digest/preview-weekly" target="_blank"
         class="btn" style="background:#f8f9fa; color:#0984e3; border:1px solid #dee2e6; text-decoration:none; display:inline-block; text-align:center;">Preview Weekly</a>
    </div>
  </div>

  <!-- Digest Subscribers -->
  <div style="border:1px solid var(--border); border-radius:8px; padding:20px; background:var(--light);">
    <h3 style="margin:0 0 12px; font-size:16px;">Digest Subscribers</h3>
    {% if pending_subscribers %}
    <table style="font-size:13px;">
      <thead>
        <tr><th>Email</th><th>Requested</th><th>Actions</th></tr>
      </thead>
      <tbody>
        {% for s in pending_subscribers %}
        <tr>
          <td>{{ s.email }}</td>
          <td style="font-size:12px; color:var(--muted);">{{ s.timestamp[:10] }}</td>
          <td>
            <form method="post" action="/admin/subscribers/approve" style="display:inline;">
              <input type="hidden" name="email" value="{{ s.email }}">
              <button type="submit" class="btn btn-sm" style="background:var(--green); color:white; border:none;">Approve</button>
            </form>
            <form method="post" action="/admin/subscribers/reject" style="display:inline; margin-left:4px;">
              <input type="hidden" name="email" value="{{ s.email }}">
              <button type="submit" class="btn btn-sm" style="background:var(--red); color:white; border:none;">Reject</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <p style="font-size:13px; color:var(--muted);">No pending subscriber requests.</p>
    {% endif %}
  </div>

</div>

<!-- Data Quality -->
<div style="border:1px solid var(--border); border-radius:8px; padding:20px; margin-bottom:24px; background:var(--light);">
  <h3 style="margin:0 0 4px; font-size:16px;">Data Quality</h3>
  <p style="font-size:13px; color:var(--muted); margin-bottom:12px;">
    Check for duplicate tickers, missing tickers, and other data issues across all monitored funds.
  </p>
  <a href="/admin/ticker-qc" class="btn btn-primary btn-sm">Run Ticker QC</a>
</div>

<!-- AI Analysis Status -->
<div style="border:1px solid var(--border); border-radius:8px; padding:20px; margin-bottom:24px; background:var(--light);">
  <h3 style="margin:0 0 12px; font-size:16px;">AI Analysis Status</h3>
  <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
    <div>
      <div style="font-size:13px; color:var(--muted);">Claude API Key</div>
      <div style="font-size:15px; font-weight:600; margin-top:2px;">
        {% if ai_configured %}
        <span style="color:var(--green);">Configured</span>
        {% else %}
        <span style="color:var(--red);">Not configured</span>
        {% endif %}
      </div>
    </div>
    <div>
      <div style="font-size:13px; color:var(--muted);">Analyses Today</div>
      <div style="font-size:15px; font-weight:600; margin-top:2px;">{{ ai_usage_today }} / 10</div>
    </div>
  </div>
</div>

{% endblock %}
