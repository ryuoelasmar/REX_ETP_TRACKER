{% extends "base.html" %}
{% block title %}ETP Filing Tracker - Dashboard{% endblock %}

{% block content %}
<div class="header">
  <h1>ETP Filing Tracker</h1>
  <div class="date">{{ today.strftime('%B %d, %Y') }} &middot; {{ trusts|length }} trusts monitored</div>
</div>

{% if added %}
<div class="alert alert-success" style="display:flex; justify-content:space-between; align-items:center;">
  <span><strong>{{ added }}</strong> has been added to monitoring. Filing data will appear after the next pipeline run.</span>
  <a href="/" style="color:#155724; font-weight:600;">Dismiss</a>
</div>
{% endif %}

<!-- KPIs -->
<div class="kpi-row">
  <div class="kpi">
    <div class="num">{{ trusts|length }}</div>
    <div class="label">Trusts</div>
  </div>
  <div class="kpi">
    <div class="num">{{ total_funds }}</div>
    <div class="label">Total Funds</div>
  </div>
  <div class="kpi kpi-green">
    <div class="num">{{ total_effective }}</div>
    <div class="label">Effective</div>
  </div>
  <div class="kpi kpi-orange">
    <div class="num">{{ total_pending }}</div>
    <div class="label">Pending</div>
  </div>
  <div class="kpi kpi-red">
    <div class="num">{{ total_delayed }}</div>
    <div class="label">Delayed</div>
  </div>
</div>

<!-- Recent Filings -->
{% if recent_filings %}
<div class="section-header">
  <h2>Recent Filings (Last 7 Days)</h2>
  <span class="badge">{{ recent_filings|length }}</span>
</div>
<table>
  <thead>
    <tr>
      <th>Date</th>
      <th>Form</th>
      <th>Trust</th>
      <th>Fund(s)</th>
      <th>Doc</th>
      <th>AI</th>
    </tr>
  </thead>
  <tbody>
    {% for row in recent_filings %}
    {% set f = row.Filing %}
    <tr>
      <td>{{ f.filing_date or '' }}</td>
      <td>{{ f.form }}</td>
      <td><a href="/trusts/{{ row.trust_slug }}">{{ row.trust_name }}</a></td>
      <td style="font-size:12px; max-width:250px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">{{ row.fund_names or '' }}</td>
      <td>
        {% if f.primary_link %}
        <a href="{{ f.primary_link }}" target="_blank">View</a>
        {% endif %}
      </td>
      <td><a href="/analysis/filing/{{ f.id }}" class="btn btn-sm" style="font-size:11px;">Analyze</a></td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% endif %}

<!-- All Trusts (Card Grid) -->
<div class="section-header" style="margin-top:30px;">
  <h2>Monitored Trusts</h2>
  <div style="display:flex; align-items:center; gap:8px;">
    <span class="badge">{{ trusts|length }}</span>
    <a href="/search/" class="btn btn-primary btn-sm">+ Request a Trust</a>
  </div>
</div>

<div class="trust-grid">
  {% set monogram_colors = ['#1565C0','#2E7D32','#6A1B9A','#C62828','#00838F','#4527A0','#AD1457','#EF6C00','#283593','#00695C','#37474F','#5D4037'] %}
  {% for t in trusts %}
  <a href="/trusts/{{ t.slug }}" class="trust-card">
    <div class="trust-card-header">
      <div class="trust-monogram" style="background:{{ monogram_colors[loop.index0 % monogram_colors|length] }};">
        {{ t.name.split()[0][0] }}{{ t.name.split()[1][0] if t.name.split()|length > 1 else '' }}
      </div>
      <div>
        <h3>{{ t.name }}</h3>
        {% if t.is_rex %}<span class="rex-badge">[REX]</span>{% endif %}
      </div>
    </div>
    {% if t.total == 0 %}
    <div class="trust-card-pending">
      Pipeline pending... <span>data appears after next run</span>
    </div>
    {% else %}
    <div class="trust-card-stats">
      <span class="trust-stat"><strong>{{ t.total }}</strong> funds</span>
      <span class="trust-stat trust-stat-green"><strong>{{ t.effective }}</strong> eff</span>
      <span class="trust-stat trust-stat-orange"><strong>{{ t.pending }}</strong> pend</span>
      {% if t.delayed > 0 %}
      <span class="trust-stat trust-stat-red"><strong>{{ t.delayed }}</strong> del</span>
      {% endif %}
    </div>
    {% endif %}
  </a>
  {% endfor %}
</div>
{% endblock %}
